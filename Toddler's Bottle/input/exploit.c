#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <unistd.h>
#include <string.h>
#include <sys/socket.h>
#include <arpa/inet.h>
#include <netinet/in.h>
int main() {
	// Stage 1
	char file_name[] = "input";
	char *argv[101] = {file_name};
	for(int i = 1; i < 100; i++) {
		argv[i] = "garbage";
	}
	argv[100] = NULL;
	argv['A'] = "\x00";
	argv['B'] = "\x20\x0a\x0d";
	argv['C'] = "55555";

	// Stage 3
	char *envp[2] = {"\xde\xad\xbe\xef=\xca\xfe\xba\xbe", NULL};

	// Stage 4
	FILE *fp = fopen("\x0a", "w");
	if(!fp) {
		fprintf(stderr, "fopen error\n");
		exit(1);
	}
	if(fwrite("\x00\x00\x00\x00", sizeof(char), 4, fp) != 4) {
		fprintf(stderr, "fwrite error\n");
		exit(1);
	}
	fclose(fp);
	
	// Stage 2
	int pipefd_stdin[2] = {-1, -1};
	int pipefd_stderr[2] = {-1, -1};
	if(pipe(pipefd_stdin) != 0) {
		fprintf(stderr, "pipe error\n");
		exit(1);
	}
	if(pipe(pipefd_stderr) != 0) {
		fprintf(stderr, "pipe error\n");
		exit(1);
	}
	int childpid = fork();
	if(childpid < 0) fprintf(stderr, "fork error\n");
	else if(childpid == 0) {
		close(pipefd_stdin[0]);
		close(pipefd_stderr[0]);
		write(pipefd_stdin[1], "\x00\x0a\x00\xff", 4);
		write(pipefd_stderr[1], "\x00\x0a\x02\xff", 4);
	}
	else {
		close(pipefd_stdin[1]);
		close(pipefd_stderr[1]);
		dup2(pipefd_stdin[0], 0);
		dup2(pipefd_stderr[0], 2);
		execve(file_name, argv, envp);
	}

	// Stage 5
	sleep(5);
	int sockfd = socket(AF_INET, SOCK_STREAM, 0);
	if(sockfd == -1) {
		fprintf(stderr, "socket error\n");
		exit(1);
	}
	struct sockaddr_in server;
	server.sin_family = AF_INET;
	server.sin_addr.s_addr = inet_addr("127.0.0.1");
	server.sin_port = htons(atoi(argv['C']));

	if(connect(sockfd, (struct sockaddr *)&server, sizeof(struct sockaddr_in)) < 0) {
		fprintf(stderr, "connect error\n");
		exit(1);
	}
	send(sockfd, "\xde\xad\xbe\xef", 4, 0);
	close(sockfd);

	return 0;
}
